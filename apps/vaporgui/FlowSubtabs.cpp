#include "FlowSubtabs.h"

QVaporSubtab::QVaporSubtab(QWidget *parent) : QWidget(parent) {
    _layout = new QVBoxLayout(this);
    _layout->setContentsMargins(0, 0, 0, 0);
    _layout->insertSpacing(-1, 20);
    setSizePolicy(QSizePolicy::Preferred, QSizePolicy::Maximum);
}

//
//================================
//
FlowVariablesSubtab::FlowVariablesSubtab(QWidget *parent) : QVaporSubtab(parent) {
    _variablesWidget = new VariablesWidget(this);
    _variablesWidget->Reinit((VariableFlags)(VECTOR | COLOR), (DimFlags)(THREED));
    _layout->addWidget(_variablesWidget, 0, 0);

    _velocityMltp = new QLineEdit(this);
    _layout->addWidget(_velocityMltp);

    _steady = new VCheckBox(this, "Use Steady Flow");
    _layout->addWidget(_steady);

    _steadyNumOfSteps = new QLineEdit(this);
    _layout->addWidget(_steadyNumOfSteps);

    connect(_steady, SIGNAL(_checkboxClicked()), this, SLOT(_steadyGotClicked()));
    connect(_velocityMltp, SIGNAL(editingFinished()), this, SLOT(_velocityMultiplierChanged()));
    connect(_steadyNumOfSteps, SIGNAL(editingFinished()), this, SLOT(_steadyNumOfStepsChanged()));
}

void FlowVariablesSubtab::Update(VAPoR::DataMgr *dataMgr, VAPoR::ParamsMgr *paramsMgr,
                                 VAPoR::RenderParams *rParams) {
    _params = dynamic_cast<VAPoR::FlowParams *>(rParams);
    assert(_params);
    _variablesWidget->Update(dataMgr, paramsMgr, rParams);

    // Update custom widgets
    bool isSteady = _params->GetIsSteady();
    _steady->SetCheckState(isSteady);

    auto mltp = _params->GetVelocityMultiplier();
    _velocityMltp->setText(QString::number(mltp, 'f', 3));

    int numOfSteps = _params->GetSteadyNumOfSteps();
    _steadyNumOfSteps->setText(QString::number(numOfSteps));
}

void FlowVariablesSubtab::_steadyGotClicked() {
    bool userInput = _steady->GetCheckState();
    _params->SetIsSteady(userInput);
}

void FlowVariablesSubtab::_velocityMultiplierChanged() {
    bool ok;
    double d = _velocityMltp->text().toDouble(&ok);
    if (ok) // Scott: this verification is no longer needed once the line edit has its own validator
        _params->SetVelocityMultiplier(d);
}

void FlowVariablesSubtab::_steadyNumOfStepsChanged() {
    bool ok;
    int i = _steadyNumOfSteps->text().toInt(&ok);
    if (ok) // Scott: this verification is no longer needed once the line edit has its own validator
        _params->SetSteadyNumOfSteps(i);
}

//
//================================
//
FlowAppearanceSubtab::FlowAppearanceSubtab(QWidget *parent) : QVaporSubtab(parent) {
    _TFWidget = new TFWidget(this);
    _TFWidget->Reinit((TFFlags)(SAMPLING | CONSTANT_COLOR));

    _layout->addWidget(_TFWidget, 0, 0);

    _params = NULL;
}

void FlowAppearanceSubtab::Update(VAPoR::DataMgr *dataMgr, VAPoR::ParamsMgr *paramsMgr,
                                  VAPoR::RenderParams *rParams) {
    _params = dynamic_cast<VAPoR::FlowParams *>(rParams);
    assert(_params);

    _TFWidget->Update(dataMgr, paramsMgr, rParams);
}

//
//================================
//
FlowSeedingSubtab::FlowSeedingSubtab(QWidget *parent) : QVaporSubtab(parent) {
    _geometryWidget = new GeometryWidget(this);
    _geometryWidget->Reinit((DimFlags)THREED, (VariableFlags)VECTOR);
    _layout->addWidget(_geometryWidget);

    _seedGenMode = new VComboBox(this, "Seed Generation Mode");
    // Index numbers are in agreement with what's in FlowRenderer.h
    _seedGenMode->AddOption("Programatically", 0);
    _seedGenMode->AddOption("From a List", 1);
    _layout->addWidget(_seedGenMode);
    connect(_seedGenMode, SIGNAL(_indexChanged(int)), this, SLOT(_seedGenModeChanged(int)));

    _fileReader = new VFileReader(this, "Seed File");
    _layout->addWidget(_fileReader);
    connect(_fileReader, SIGNAL(_pathChanged()), this, SLOT(_fileReaderChanged()));
}

void FlowSeedingSubtab::Update(VAPoR::DataMgr *dataMgr, VAPoR::ParamsMgr *paramsMgr,
                               VAPoR::RenderParams *params) {
    _params = dynamic_cast<VAPoR::FlowParams *>(params);

    // VAPoR::Box* rakeBox = params->GetRakeBox();
    //_geometryWidget->Update(paramsMgr, dataMgr, params, rakeBox);
    _geometryWidget->Update(paramsMgr, dataMgr, params);

    long idx = _params->GetSeedGenMode();
    if (idx >= 0 && idx < _seedGenMode->GetNumOfItems())
        _seedGenMode->SetIndex(idx);
    else
        _seedGenMode->SetIndex(0);

    // Scott to implement this functionality
    // _fileReader->UpdateDisplayText( _params->GetSeedInputFilename() );
}

void FlowSeedingSubtab::_seedGenModeChanged(int newIdx) {
    _params->SetSeedGenMode(newIdx);
    std::cout << newIdx << std::endl;
}

void FlowSeedingSubtab::_fileReaderChanged() {
    // Scott: needs to ask FileSelector actually emit a signal
    std::string filename = _fileReader->GetPath();
    _params->SetSeedInputFilename(filename);
    std::cout << filename << std::endl;
}

//
//================================
//
FlowGeometrySubtab::FlowGeometrySubtab(QWidget *parent) : QVaporSubtab(parent) {
    _geometryWidget = new GeometryWidget(this);
    _copyRegionWidget = new CopyRegionWidget(this);
    _transformTable = new TransformTable(this);
    _geometryWidget->Reinit((DimFlags)THREED, (VariableFlags)VECTOR);

    _layout->addWidget(_geometryWidget, 0, 0);
    _layout->addWidget(_copyRegionWidget, 0, 0);
    _layout->addWidget(_transformTable, 0, 0);

    _params = NULL;
}

void FlowGeometrySubtab::Update(VAPoR::ParamsMgr *paramsMgr, VAPoR::DataMgr *dataMgr,
                                VAPoR::RenderParams *rParams) {
    _params = dynamic_cast<VAPoR::FlowParams *>(rParams);
    assert(_params);

    _geometryWidget->Update(paramsMgr, dataMgr, rParams);
    _copyRegionWidget->Update(paramsMgr, rParams);
    _transformTable->Update(rParams->GetTransform());
}

//
//================================
//
FlowAnnotationSubtab::FlowAnnotationSubtab(QWidget *parent) : QVaporSubtab(parent) {
    _colorbarWidget = new ColorbarWidget(this);
    _layout->addWidget(_colorbarWidget, 0, 0);
}

void FlowAnnotationSubtab::Update(VAPoR::ParamsMgr *paramsMgr, VAPoR::DataMgr *dataMgr,
                                  VAPoR::RenderParams *rParams) {
    _colorbarWidget->Update(dataMgr, paramsMgr, rParams);
}
